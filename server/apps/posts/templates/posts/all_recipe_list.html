<!DOCTYPE html>
<html lang="ko">
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>장금이 요리백서</title>
        {% load static %}
        {% load filter %}
        <link rel="stylesheet" href="{% static 'css/main.css' %}" />
        <link rel="stylesheet" href="{% static 'css/all_recipe_list.css'%}" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Nanum+Brush+Script&family=Yeon+Sung&display=swap" rel="stylesheet" />
    </head>
    <body>
        {% include 'posts/header.html' %}
        <div>전체 레시피</div>
        
        <span id="user_name">{{ user.username }}</span>
        <form action = "{% url 'posts:all_recipe'%}" method="get">
            <select name="sort">
                {% if sortN == "likes" %}
                    <option value="recently" id="recently">최신순</option>
                    <option value="likes" id="likes" selected>좋아요순</option>
                {% else %}
                    <option value="recently" id="recently" selected>최신순</option>
                    <option value="likes" id="likes">좋아요순</option>
                {% endif %}
                {% comment %} <option value="comments" id="comments>">댓글순</option> {% endcomment %}
            </select>
            <button type="submit">정렬</button>
        </form>
        <form action="{% url 'posts:all_recipe' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input name="search-name"/>

            <input type="submit" , value="검색" />

        </form>
        <div>

            {% for post in posts %}
            <article class="backgorundcolor"></article>
                <div>
                    <div id="post_id{{post.id}}"></div>
                    <button onclick="onClickDetail({{post.id}})">{{post.title}}</button>
                    {% comment %} <a href= "{%url 'posts:profile' post.user_pk%}" class = "writer_name">{{ post.user }}</a> {% endcomment %}
                    <div>
                        <span class = "writer_name">{{ post.user.name }}</span>
                        <span>({{post.user}})</span>
                    </div>
                    {% if post.photo %}
                    <p>
                        <img src="{{ post.photo.url }}" />
                    </p>
                    {% endif %}
                    <div>
                        <button class="like_{{post.id}}" onclick="onClickLike({{post.id}})">좋아요</button>
                        <div class="like_dislike">좋아요 개수: {{post.number}}</div>
                        <div>{{post.created_at}}</div>
                    </div>
                    <div>
                        {%for ele in post.ingredientList%}
                        <div>{{ele}}</div>
                        {%endfor%}
                    </div>
                </div>
            </article>
            <form action="{% url 'posts:delete' post.pk %}" method="post">
                {% csrf_token %}
                <input type="submit" class="delete", value="삭제하기" />
            </form>
            <form action="{% url 'posts:update' post.pk %}" method="get">
                {% csrf_token %}
                <input type="submit" class="update" value="수정하기" />
            </form>
            {% endfor %}
        </div>
        <div id="list_container" style="width: 500px; height:100%; background-color: aqua" class="post_detail">
        </div>
        <script src="http://code.jquery.com/jquery-latest.js"></script>
        <script>    
            const requestDetail = new XMLHttpRequest();
            const requestLike = new XMLHttpRequest();
            const requestComment = new XMLHttpRequest();
            const onClickDetail = (id) => {
                const url = "/detail_ajax/";
                requestDetail.open("POST", url, true);
                requestDetail.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
                );
                requestDetail.send(JSON.stringify({ id: id}));
            };
        
            requestDetail.onreadystatechange = () => {
                if (requestDetail.readyState === XMLHttpRequest.DONE) {
                if (requestDetail.status < 400) {
                    const { post_id, post_title, post_photo, post_content, post_created, photo_url, ingredientL, comment_id_L, comment_userid_L, comment_content_L, comment_created_L } = JSON.parse(requestDetail.response);
                    let div_generate = ``;
                    for (let i = 0; i < ingredientL.length; i++){
                         div_generate += `<div>${ingredientL[i]}</div>`;
                    }
                    // let comments_list = ``;
                    // for (let k = 0; k < comment_id_L.length; k++){
                    //     comments_list += `
                    //     <div class="comment_id_${comment_id_L[k]}">
                    //         <p>댓글: ${comment_content_L[k]}</p>
                    //         <button onclick="onClickDelete(${post_id}, ${comment_id_L[k]})">댓글 삭제</button>
                    //         <hr>
                    //     </div>`
                    // }
                    let templatetag = "{% if post.id == comment.post_id.id %}".replace("post.id", post_id);
                    let templatetag2 = "{% endif %}";
                    const element1 = document.querySelector(`.post_detail`);
                    const originHTML1 = element1.innerHTML;
                    const detail_list = originHTML1;
                    element1.innerHTML = `<div>레시피 상세보기</div>
                <article class="다른 backgorund color클래스">
                    <div class="post_title">${post_title}</div>
                    <div>` 
                        + div_generate +
                    `</div>
                    <div>
                        <p>
                            <img src="${photo_url}" />
                        </p>
                        <div class="post_content">${post_content}</div>
                    </div>
                    <div>
                        <div>
                            <div class="post_created">${post_created.slice(2, 10)}</div>
                        </div>
                    </div>

                    //새로 수정중인 댓글 코드
                    <div>
                        <div>
                            <div>
                                {%csrf_token%}
                                <div>
                                    <textarea id="content_id" placeholder="댓글을 입력해주세요"></textarea>
                                </div>
                                <div>
                                    <button id="comment_write" onClick="onClickComment(${post_id})">댓글달기</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div id="more_comment{{post_id}}">
                        {%if comments%}
                            {%for comment in comments%}
                                <div id='{{comment.id}}'>
                                    {%if comment.deleted%}
                                    <span>삭제된 댓글입니다.</span><hr>
                                    {% else %}
                                        {% if comment.user_id == post.user %}
                                        <strong>{{comment.user_id.name}}({{comment.user_id}})&nbsp;<span>글쓴이</span></strong>
                                        {% else %}
                                        <strong>{{comment.user_id.name}}({{comment.user_id}})</strong>
                                        {% endif %}
                                        <span>{{comment.created_at}}</span>
                                        {% if comment.user_id == request.user %}
                                        <div>
                                            <div>{{comment.content}}</div>
                                            <div>
                                                <a onclick="commentDelete('{{comment.id}}');">댓글삭제</a>
                                            </div>
                                        </div>
                                        <hr>
                                        {% else %}
                                        <div>
                                            <div>{{comment.content}}</div>
                                        </div>
                                        <hr>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class='{{comment.id}}'></div>
                            {% endfor %}
                        {%endif%}
                        <input type="hidden" id="comment_writer" value={{request.user}}>
                        <div id="comment_list{{post_id}}"></div>
                    </div>
                    
                `;
                }
                }
            };
        
            //기존 댓글 코드
                    {% comment %} <div class="comment_main">
                        <div class="comment">
                            <textarea class="comment_form_${post_id}" 
                                id="content_id" 
                                cols="30" rows="1" 
                                placeholder="댓글을 입력하세요.">
                            </textarea>
                        </div>
                        <div class="comment_send">
                            <button onclick="onClickComment(${post_id})" id="comment_write">댓글 달기</button>
                        </div>
                    </div>
                </article>
                <div class="comment_list_${post_id}">
                    {% if comments %}
                        {% for comment in comments %}`
                            + templatetag +
                            `<div class="comment_id_{{comment.id}}">
                                <p>댓글: {{comment.content}}</p>
                                <button onclick="onClickDelete({${post_id}, {{comment.id}})">댓글 삭제</button>
                                <hr>
                            </div>`
                            + templatetag2 +
                        `{% endfor %}
                    {% endif %}
                </div> {% endcomment %}


            {% comment %} const onClickComment = (id) => {
                const url = "/comment_ajax/";
                let content = document.querySelector(`.comment_form_${id}`).value;
                requestComment.open("POST", url, true);
                requestComment.setRequestHeader(
                    "Content-Type",
                    "application/x-www-form-urlencoded"
                );
                requestComment.send(JSON.stringify({ id: id, content: content}));
            };
        
            requestComment.onreadystatechange = () => {
                if (requestComment.readyState === XMLHttpRequest.DONE) {
                if (requestComment.status < 400) {
                    const { post_id, user_id, comment_id, content } = JSON.parse(requestComment.response);
                    const element = document.querySelector(`.comment_list_${post_id}`);
                    const originHTML = element.innerHTML;
                    element.innerHTML = originHTML + `
                    <div class="comment_id_${comment_id}">
                        <p>댓글: ${content}</p>
                        <button onclick="onClickDelete(${post_id}, ${comment_id})">삭제</button>
                        <hr>
                    </div>`;
                }
                }
            }; {% endcomment %}
            
            const onClickLike = (id) => {
                const url = "/like_ajax/";
                requestLike.open("POST", url, true);
                requestLike.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
                );
                requestLike.send(JSON.stringify({ id: id}));
            };
        
            requestLike.onreadystatechange = () => {
                if (requestLike.readyState === XMLHttpRequest.DONE) {
                if (requestLike.status < 400) {
                    const { like_true, number } = JSON.parse(requestLike.response);
                    // const element = document.querySelector(`.like_{{post.id}}`);
                    const element = document.querySelector(`.like_dislike`);
                    const originHTML = element.innerHTML;
                    const like_list = originHTML;
                    location.reload();
                    if (like_true = true){
                        const count = Number(number) - 1;
                        element.innerHTML = `좋아요 개수: ${count}`;
                    }else{
                        const count = Number(number) + 1;
                        element.innerHTML = `좋아요 개수: ${count}`;
                    }
                }
                }
            };
            

            const onClickComment = (pk) => {
                console.log("hello")
                var content = $("#content_id").val();
                var writer = $("#comment_writer").val();
                
                var pk = pk
                console.log(pk)
                var url = "{% url 'posts:comment_create' 1234%}".replace(/1234/, pk);
                $.ajax({
                    type : "POST",
                    url: url,
                    dataType: "json",
                    data: {
                        'comment_writer' : writer,
                        'content' : content,
                        'csrfmiddlewaretoken': '{{csrf_token}}',
                    },
                    success : function (response){
                        if (response.self_comment){
                            console.log("일치", response)

                            $(`#comment_list${pk}`).append(
                                '<div><div id='+response.comment_id+'><strong>'+response.comment_writer+'&nbsp;<span>'+response.self_comment+'</span></strong>'+
                                    '<span>'+response.created+'</span>'+
                                    '<div><div>'+response.content+
                                    '</div><div><a onclick="commentDelete('+response.comment_id+');">댓글삭제</a></div></div><hr></div><div class='+response.comment_id+'></div>'
                            );
                        }
                        else{
                            console.log("불일치", response)
                            $(`#comment_list${pk}}`).append(

                                '<div><div id='+response.comment_id+'><strong>'+response.comment_writer+'</strong>'+
                                '<span>'+response.created+'</span>'+
                                '<div><div >'+response.content+
                                '</div><div ><a onclick="commentDelete('+response.comment_id+');">댓글삭제</a></div></div><hr></div><div class='+response.comment_id+'></div>'
                            );
                        }
                        $('#content_id').val("");
                    },
                    error: function (){
                        if ($('#content_id').val()==""){
                            alert('댓글을 입력해주세요.');
                        }
                    },
                })
            }

            function commentDelete(value){
                var comment_id = value;
                var delete_warning = confirm('댓글을 삭제하시겠습니까?');
                if (delete_warning == true){
                    $.ajax({
                        type: "POST",
                        url : "{% url 'posts:comment_delete' 1234%}".replace(/1234/, comment_id),

                        dataType: "json",
                        data: {
                            "comment_id" : comment_id,
                            'csrfmiddlewaretoken': '{{csrf_token}}',
                        },
                        success: function(response){
                            $('#'+response.comment_id).replaceWith('<span ">삭제된 댓글입니다.</span><hr>');
                        },
                        error: function () {
                            alert('본인 댓글이 아닙니다.');
                        },
                    });
                }
            }

            //수정, 삭제 버튼 해당 유저만 보이도록 구현
            $username = $("#user_name").text()
            $(".writer_name")[0].innerHTML
            for(i = 0; i < $(".writer_name").length; i++){
                if($("#user_name").text() != $(".writer_name")[i].innerHTML){
                  
                  $(".update")[i].type = "hidden";
                  $(".delete")[i].type = "hidden";
                }
              }
        </script>
    </body>
</html>